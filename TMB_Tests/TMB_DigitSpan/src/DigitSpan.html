<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Metadata ************************************************************** -->
  <meta charset="UTF-8">
  <meta name="description" content="TMB Digit Span">
  <meta name="copyright" content="2023 The Many Brains Project, Inc. and McLean Hospital LGPLv3">
  <meta name="keywords" content="cognitive test, brain test, digit memory span">

  <!-- Configs for mobiles -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="TMB DigitSpan">
  <meta name="theme-color" content="white">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico">

  <!-- Title ***************************************************************** -->
  <title>Memorizing Numbers</title>

  <!-- Styles **************************************************************** -->
  <style nonce="***tmb_inline_tag_nonce***">
    *{border-radius:0;box-sizing:border-box}
    *::after,*::before{box-sizing:border-box}
    html{width:100vw;height:100vh}
    body{width:100vw;height:100vh;margin:auto;background:#fff;color:#000;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:13pt;text-align:center}
    #container{width:600px;height:768px;position:absolute;top:50%;left:50%;margin-top:-384px;margin-left:-300px;text-align:center;display:none}
    .button{border:2px solid #f1c40f;border-radius:1em;background:transparent;color:#000;box-shadow:0 5px 15px 5px grey}
    .button:active{box-shadow:0 5px 15px 1px lightgrey}
    .button:focus{outline:none}
    #feedback{font-size:30pt;line-height:2em;height:100px;text-align:center;display:none}
    #digits{font-family:monospace;font-size:60pt;line-height:1.5em;height:150px;text-align:center;display:none}
    #responseContainer{width:340px;height:440px;margin:auto;text-align:center;display:none}
    .responseButton{-webkit-appearance:none;background:darkgrey;font-size:40pt;line-height:1.5em;width:100px;height:100px;margin:5px;border:5px solid lightgray;border-right:5px solid #727272;border-bottom:5px solid #727272;padding:0;color:#fff;text-align:center;font-family:"Palatino Linotype","Bookman Antiqua",Palatino,serif}
    .deleteButton{-webkit-appearance:none;background:darkgrey;font-size:40pt;line-height:1.5em;height:100px;margin:5px;border:5px solid lightgray;border-right:5px solid #727272;border-bottom:5px solid #727272;padding:0;color:#fff;text-align:center;font-family:"Palatino Linotype","Bookman Antiqua",Palatino,serif;width:330px}
    .responseButton:focus{outline:none}
    .responseHighlight{border:5px solid red}
  </style>

  <!-- Required libs ********************************************************* -->
  <script type="text/javascript" nonce="***tmb_inline_tag_nonce***" src="TestMyBrain.12.18.min.js"></script>
  <script type="text/javascript" nonce="***tmb_inline_tag_nonce***" src="chooseInput.v1.Apr23.js"></script>
  <script type="text/javascript" nonce="***tmb_inline_tag_nonce***" src="TestHelper.v1.May23.js"></script>

  <!-- App script ************************************************************ -->
  <script type="text/javascript" nonce="***tmb_inline_tag_nonce***">
    var testVersion,chosenInput,previous=true,response="",testStart=0,chainSeq=[],frameSequence=[],frame,results=[],outcomes={},score=0,reportOrder,seed,debug,demo,showresults,autosave,filename,usage="";

    // Main input handler
    tmbUI.onreadyUI = function(){
      if(debug === 'true' && tmbUI.message) console.log(tmbUI.message);

      if(tmbUI.status === "timeout"){
        var digits = frame.digits.length - response.length;
        getID("feedback").innerHTML = "Press " + digits + (digits === 1 ? " more number." : (response.length === 0 ? " numbers." : " more numbers."));
        tmbUI.getInput();
      } else {
        if(tmbUI.response === 'backspace'){
          getID("digits").innerHTML = getID("digits").innerHTML.slice(0,-1);
          response = response.slice(0,-1);
        } else {
          if(reportOrder === 'backward'){ var corr = frame.digits.slice(); corr = corr.reverse(); }
          getID("digits").innerHTML += tmbUI.response.slice(-1);
          response += tmbUI.response.slice(-1);
        }

        if (response.length < frame.digits.length){
          if(frame.type === "test") getID("feedback").innerHTML = "";
          tmbUI.getInput();
        }
        else if ((reportOrder === 'forward' && response === frame.digits.join("")) ||
                 (reportOrder === 'backward' && response === corr.join(""))){
          results.push({ type:frame.type, digits:frame.digits.join(""), response:response, correct:1, rt:(now()-testStart).round(2), state:tmbUI.status });
          if(debug === 'true') logResults(results,'inc');
          response = ""; previous = true;
          if (frame.type === "practice") getID("feedback").innerHTML = "Correct!"; else getID("feedback").innerHTML = "";
          if(!frameSequence.length) score = frame.digits.length;
          setTimeout(function(){ showFrame(null); nextTrial(); }, 1000);
        }
        else {
          results.push({ type:frame.type, digits:frame.digits.join(""), response:response, correct:0, rt:(now()-testStart).round(2), state:tmbUI.status });
          if(debug === 'true') logResults(results,'inc');
          response = "";
          if (frame.type === "practice"){
            getID("feedback").innerHTML = "That was " + (reportOrder === 'forward' ? frame.digits.join("") : corr.join("")) + ". Try again!";
            frameSequence.unshift(frame);
          }
          else if(!frameSequence.length){
            if(previous === false) score = frame.digits.length - 1;
            else score = frame.digits.length;
          }
          else if(frame.digits.length < frameSequence[0].digits.length && previous === false){
            score = frame.digits.length - 1;
            frameSequence = [];
          }
          else previous = false;

          setTimeout(function(){ showFrame(null); nextTrial(); }, (frame.type === "practice" ? 2000 : 1000));
        }
      }
    };

    // Trial loop
    function nextTrial(){
      frame = frameSequence.shift();
      if (frame){
        if (frame.type === "begin")
          showAlert(frame.message, "Click here for instructions", function(){ showFrame(null); nextTrial(); }, '20pt');
        else if (frame.type === "message")
          showAlert(frame.message, "Click here to continue", function(){ showFrame(null); nextTrial(); }, '20pt');
        else {
          chainSeq = [];
          function setDigit(i){
            chainSeq.push(1000, function(){ getID("digits").innerHTML = frame.digits[i]; });
          }
          chainSeq.push(function(){ if(frame.type === "practice") getID("feedback").innerHTML="Memorize the numbers!"; else getID("feedback").innerHTML=""; getID("digits").innerHTML=""; },
                        1000,
                        function(){ if(chosenInput==='taps') showFrame("container","responseContainer","feedback","digits"); else showFrame("container","feedback","digits"); });

          for(var i=0;i<frame.digits.length;i++) setDigit(i);

          chainSeq.push(1000, function(){ getID("digits").innerHTML=""; getID("feedback").innerHTML="Now press the numbers..."; testStart=now(); tmbUI.getInput(); });
          tmbUI.timeout = 3000;

          requestAnimationFrame(function(){ chainTimeouts(chainSeq); });
        }
      } else {
        // End of test: compute outcomes
        var tmp1 = results.filter(function(o){ return o.type!=='practice' && o.state!=='timeout'; });
        var tmp2 = tmp1[0] ? tmp1[0].state : null;
        tmp2 = /key/i.test(tmp2)?'keyboard' : /touch/i.test(tmp2)?'touch' : /mouse/i.test(tmp2)?'mouse' : /pen/i.test(tmp2)?'pen' : 'unknown';

        outcomes.score = score;
        outcomes.numCorrect = tmp1.length ? tmp1.pluck("correct").sum() : 0;
        outcomes.span = score;
        outcomes.reportOrder = reportOrder;
        outcomes.responseDevice = tmp2;
        outcomes.testVersion = testVersion;

        if(debug === "true") logResults([outcomes],'cum');

        /* ---- POST RESULT TO QUALTRICS ---- */
        try {
          var pidParam = getUrlParameters("pid","",true) || "";
          window.parent.postMessage(
            {
              type: "DIGITSPAN_RESULT",
              pid: pidParam,
              span: outcomes.span,             // primary: highest length recalled correctly
              numCorrect: outcomes.numCorrect, // QC: total correct trials
              order: outcomes.reportOrder,     // forward/backward
              device: outcomes.responseDevice  // keyboard/touch/mouse/pen
            },
            "https://capilanopsych.yul1.qualtrics.com"  // Qualtrics origin
          );
        } catch(e){}

        // Save or show
        if(showresults === "true" || autosave === 'true' || filename){
          outcomes.type='summaryScores'; results.push(outcomes);
          showAlert("Your score is " + score + ".<br><br>The test is over.<br>Thank you for participating!<br><br>","",null,'20pt');
          setTimeout(function(){ if(filename===false) filename=reportOrder+"SpanResults.csv"; tmbSubmitToFile(results,filename,autosave); },2000);
        } else {
          tmbSubmitToServer(results,score,outcomes);
        }
      }
    }

    // Build frame sequence
    function setFrameSequence(){
      var testMessage = {
        begin: ("<h2>Memorizing Numbers</h2>- " + reportOrder + " version -<br><img src='images/begin.gif' alt='Title gif'><br><br>"),
        practice: [
          ("<h3>Instructions:</h3><img src='images/digitsStream.gif' alt='Instructions gif'><br>Try to remember these numbers.<br><br>"),
          ("<h3>Instructions:</h3><img src='images/"+reportOrder+"DigitsSeq.gif' alt='Instructions gif'><br>"+
           (chosenInput==='taps' ? "Then tap the numbers<br>" : "Then press the numbers on the <b>keyboard</b><br>") +
           (reportOrder==='forward' ? "in the order you saw them.<br>" : "in <b>reverse</b> order.<br>") +
           "Let's practice!<br><br>")
        ],
        test: ("Excellent!<br>You have completed the practice.<br>Now let's do more.<br><br>To correct mistakes<br>you can press backspace/delete.<br><br>")
      };

      var frameType = ["begin","message","message","practice","practice","message",
                       "test","test","test","test","test","test","test","test","test","test",
                       "test","test","test","test","test","test","test","test","test","test"];

      var frameMessage = [testMessage.begin, testMessage.practice[0], testMessage.practice[1], "", "", testMessage.test,
                          "","","","","","","","","","", "","","","","","","","","",""];

      var sequence = [];
      for(var i=0;i<8;i++){ sequence[i*2] = range(1,9).shuffle().slice(0,i+2); sequence[i*2+1] = range(1,9).shuffle().slice(0,i+2); }
      sequence[16] = range(1,9).shuffle().concat(randInt(1,9));
      sequence[17] = range(1,9).shuffle().concat(randInt(1,9));
      sequence[18] = range(1,9).shuffle().concat(range(1,9).shuffle().slice(0,2));
      sequence[19] = range(1,9).shuffle().concat(range(1,9).shuffle().slice(0,2));

      var frameDigits = [[],[],[],[1,2],[1,2,3],[]].concat(sequence);

      for(var i=0; (demo==="true"? i<10 : i<frameType.length); i++){
        frameSequence.push({ type:frameType[i], message:frameMessage[i], digits:frameDigits[i] });
      }
    }

    function setup(input){
      chosenInput = input;
      if(chosenInput === 'taps'){
        tmbUI.UIevents = 'taps';
        tmbUI.UIelements = ['response1','response2','response3','response4','response5','response6','response7','response8','response9','backspace'];
        tmbUI.highlight = "responseHighlight";
      } else {
        tmbUI.UIevents = ['keys'];
        tmbUI.UIkeys = [keyToCode('1'),keyToCode('2'),keyToCode('3'),keyToCode('4'),keyToCode('5'),keyToCode('6'),
                        keyToCode('7'),keyToCode('8'),keyToCode('9'),
                        keyToCode('numpad1'),keyToCode('numpad2'),keyToCode('numpad3'),
                        keyToCode('numpad4'),keyToCode('numpad5'),keyToCode('numpad6'),
                        keyToCode('numpad7'),keyToCode('numpad8'),keyToCode('numpad9'),
                        keyToCode('backspace')];
        getID("container").style.height = "600px";
        getID("container").style.marginTop = "-300px";
      }
      tmbUI.timeout = 4000;

      setFrameSequence();
      imagePreLoad(["images/begin.gif","images/digitsStream.gif","images/"+reportOrder+"DigitsSeq.gif"], {callBack: nextTrial});
    }

    window.onload = function(){
      var copyright = "Copyright " + document.querySelector('meta[name="copyright"]').content;
      var scriptName = window.location.pathname.split('/').pop();

      if ((usage = getUrlParameters("help","",true))){
        showAlert("<p id='helpSpan'><b>"+document.title+"</b><br><i>"+copyright+
          "</i><br><br><b>Usage:</b><br>"+scriptName+"?urlParam1=1&urlParam2=0<br><br>"+
          "<b>URL Parameters</b>:<br>"+
          "<i>order=forward</i> -- how to report digits [forward,backward]<br>"+
          "<i>seed=123</i> -- random number generator seed<br>"+
          "<i>demo=true</i> -- runs in demo mode, only a few test trials<br>"+
          "<i>debug=true</i> -- outputs trial by trial info to the console<br>"+
          "<i>showresults=true</i> -- allows to save results locally in a file<br>"+
          "<i>autosave=true</i> -- will attempt to save results automatically to file<br>"+
          "<i>filename=subject1.csv</i> -- the filename to save results to<br>"+
          "<i>help</i> -- print this message");
        document.getElementById('helpSpan').style.textAlign='left';
        document.getElementById('helpSpan').style.margin='50px';
        return;
      }

      reportOrder = getUrlParameters("order","",true);
      if(reportOrder !== 'forward' && reportOrder !== 'backward') reportOrder = 'forward';
      debug = getUrlParameters("debug","",true);
      demo = getUrlParameters("demo","",true);
      showresults = getUrlParameters("showresults","",true);
      autosave = getUrlParameters("autosave","",true);
      filename = getUrlParameters("filename","",true);

      seed = getUrlParameters("seed","",true);
      if(!(seed = parseInt(seed))){ seed = reportOrder+"Span"; } else { seed = reportOrder+parseInt(seed); }
      Math.seedrandom(seed);

      testVersion = scriptName.replace(/\.[^/.]+$/, "");
      disableSelect(); disableRightClick(); disableDrag(); disableDoubleTapZoom();
      setBodyScale(620,900);

      if(!hasTouch) setup('keys'); else chooseInput({keyboard:true, touch:true}, setup);
    }
  </script>
</head>

<body>
  <div id="container">
    <div id="feedback"></div>
    <div id="digits"></div>
    <div id="responseContainer">
      <button type="button" id="response1" class="responseButton">1</button>
      <button type="button" id="response2" class="responseButton">2</button>
      <button type="button" id="response3" class="responseButton">3</button>
      <button type="button" id="response4" class="responseButton">4</button>
      <button type="button" id="response5" class="responseButton">5</button>
      <button type="button" id="response6" class="responseButton">6</button>
      <button type="button" id="response7" class="responseButton">7</button>
      <button type="button" id="response8" class="responseButton">8</button>
      <button type="button" id="response9" class="responseButton">9</button>
      <button type="button" id="backspace" class="deleteButton">&#9003;</button>
    </div>
  </div>

  <noscript>
    For full functionality of this site it is necessary to enable JavaScript.<br>
    Here are the <a href="https://www.enable-javascript.com/" target="_blank" rel="noopener noreferrer">instructions</a> how to enable JavaScript in your web browser.
  </noscript>
</body>
</html>

