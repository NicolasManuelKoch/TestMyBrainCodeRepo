<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="TMB Simple Reaction Time">
<meta name="copyright" content="2023 The Many Brains Project, Inc. and McLean Hospital LGPLv3">
<meta name="keywords" content="cognitive test, brain test, simple reaction time">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="TMB SRT">
<meta name="theme-color" content="white">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" href="/favicon.ico">
<title>Fast Reactions</title>
<style>
  *{border-radius:0;box-sizing:border-box}
  *::after,*::before{box-sizing:border-box}
  html{width:100vw;height:100vh}
  body{width:100vw;height:100vh;margin:auto;background:#fff;color:#000;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:13pt;text-align:center}
  .button{border:2px solid #f1c40f;border-radius:1em;background:transparent;color:#000;box-shadow:0 5px 15px 5px grey}
  .button:active{box-shadow:0 5px 15px 1px lightgrey}
  .button:focus{outline:none}
  .stim{width:200px;height:160px;clear:both;border:1px solid #000;position:absolute;left:50%;top:50%;margin-top:-80px;margin-left:-100px;text-align:center;font-size:50px}
  #hold{display:none;background-color:#ff0000}
  #go{display:none;background-color:#00FF00}
</style>

<!-- required libs -->
<script type="text/javascript" src="TestMyBrain.12.18.min.js"></script>
<script type="text/javascript" src="chooseInput.v1.Apr23.js"></script>
<script type="text/javascript" src="TestHelper.v1.May23.js"></script>

<script type="text/javascript">
var testVersion, chosenInput, score=0, outcomes={}, results=[], frameSequence=[], ch, frame;
var seed, ntrials, nopractice, useChooseInput, debug, demo, showresults, autosave, filename, usage="";

// Handle responses
tmbUI.onreadyUI = function(){
  clearChainTimeouts(ch);
  if(debug === 'true' && tmbUI.message) console.log(tmbUI.message);

  results.push({ type: frame.type, foreperiod: frame.delay, response: tmbUI.response, rt: tmbUI.rt, dwell: tmbUI.dwell, state: tmbUI.status });
  if(debug === 'true') logResults(results,'inc');

  if(tmbUI.status === "timeout"){
    frameSequence.unshift(frame);
    showAlert("Please respond within 2 seconds.<br><br>When you see <b>GO!</b>,<br>" +
              (chosenInput==='taps' ? "<b>TAP</b> as quickly as you can.<br><br>" : "press the <b>SPACE BAR</b> as quickly as you can.<br><br>"),
              (chosenInput==='taps' ? "Click here to retry" : ''),
              function(){ hideCursor("document.body"); showFrame("null"); setTimeout(function(){nextTrial();},1000); },
              '20pt', null, (chosenInput==='taps'?null:'Press the SPACEBAR to retry'));
  } else {
    nextTrial();
  }
};

function nextTrial(){
  frame = frameSequence.shift();
  if (frame){
    if (frame.type === "begin"){
      showAlert(frame.message, (chosenInput==='taps'?"Click here for instructions":''), function(){nextTrial();}, '20pt', null, (chosenInput==='taps'?null:'Press the SPACEBAR for instructions'));
    } else if (frame.type === "message"){
      showAlert(frame.message, (chosenInput==='taps'?"Click here to continue":''), function(){ hideCursor("document.body"); showFrame("null"); setTimeout(function(){nextTrial();},1000); }, '20pt', null, (chosenInput==='taps'?null:'Press the SPACEBAR to continue'));
    } else {
      hideCursor("document.body");
      ch = chainTimeouts(
        function(){ requestAnimationFrame(function(){ showFrame(null); }); },
        700,
        function(){ requestAnimationFrame(function(){ showFrame("hold"); }); },
        frame.delay,
        function(){ requestAnimationFrame(function(){ showFrame("go"); tmbUI.getInput(); }); }
      );
    }
  } else {
    showCursor("document.body");
    // compute outcomes
    var tmp1 = results.filter(function(o){ return o.type!=='practice' && o.state!=='timeout'; });
    var rts  = tmp1.pluck('rt');
    var dev  = tmp1[0] ? tmp1[0].state : null;
    dev = /key/i.test(dev)?'keyboard' : /touch/i.test(dev)?'touch' : /mouse/i.test(dev)?'mouse' : /pen/i.test(dev)?'pen' : 'unknown';

    if(rts.length){
      score = rts.average();
      score = score < 100 ? 100 : 10000 / score; // 100 max, else 10000/meanRT
      score = score.round(2);
    } else score = 0;

    outcomes.score      = score;
    outcomes.meanRT     = rts.length ? rts.average().round(2) : 0;
    outcomes.medianRT   = rts.length ? rts.median().round(2) : 0;
    outcomes.sdRT       = rts.length ? rts.sd().round(2) : 0;
    outcomes.responseDevice = dev;
    outcomes.testVersion    = testVersion;

    if(debug === "true") logResults([outcomes], 'cum');

    /* ---- POST RESULT TO QUALTRICS ---- */
    try {
      var pidParam = getUrlParameters("pid","",true) || "";
      window.parent.postMessage(
        {
          type: "SRT_RESULT",
          pid: pidParam,
          score: outcomes.score,
          meanRT: outcomes.meanRT,
          medianRT: outcomes.medianRT,
          sdRT: outcomes.sdRT,
          device: outcomes.responseDevice
        },
        "https://capilanopsych.yul1.qualtrics.com"  // your Qualtrics origin
      );
    } catch(e){}

    // local save or server (unchanged behavior)
    if(showresults === "true" || autosave === 'true' || filename){
      outcomes.type='summaryScores'; results.push(outcomes);
      showAlert("Your score is " + score + ".<br>The maximum score is 100.<br><br>The test is over.<br>Thank you for participating!<br><br>","",null,'20pt');
      setTimeout(function(){ if(filename===false) filename="sRTresults.csv"; tmbSubmitToFile(results,filename,autosave); },2000);
    } else {
      tmbSubmitToServer(results,score,outcomes);
    }
  }
}

function setFrameSequence(){
  var testMessage = {
    begin: ("<h2>Fast Reactions</h2><br><img src='SimpleRT.gif' alt='Title'><br><br>How fast can you react?<br><br>"),
    practice: [("<h3>Instructions:</h3><img src='SimpleRT.gif' alt='Title'><br><br>When you see <b>GO!</b><br>"+(chosenInput==='taps'?"<b>TAP</b> ":"press the <b>SPACE BAR</b><br>")+"as quickly as you can.<br><br>Use a finger on your writing hand.<br><br>"),
               ("Excellent!<br>You have completed the practice.<br><br>Now let's do more.<br><br>")],
    test: "When you see <b>GO!</b><br>"+(chosenInput==='taps'?"<b>TAP</b> ":"press the <b>SPACE BAR</b><br>")+"as quickly as you can.<br><br>"
  };

  var frameType = ["begin"];
  var frameMessage = [testMessage.begin];

  if(!nopractice || nopractice === 'false'){
    frameType = frameType.concat(["message","practice","practice","practice","message"]);
    frameMessage = frameMessage.concat([testMessage.practice[0],"","","",testMessage.practice[1]]);
  }

  frameType = frameType.concat(["message"]);
  frameMessage = frameMessage.concat([testMessage.test]);

  for(var i=0;i<frameType.length;i++){
    frameSequence.push({ type: frameType[i], message: frameMessage[i], delay: 1000 });
  }

  // Delays (quantized) with optional shuffling by seed
  var frameDelay = [1300,700,700,700,700,1100,700,1100,900,900,
                    700,700,1300,1100,1300,700,900,700,1500,700,
                    1500,900,900,700,1100,900,700,900,700,900,
                    1300,700,700,700,700,1100,700,1100,900,900,
                    700,700,1300,1100,1300,700,900,700,1500,700,
                    1500,900,900,700,1100,900,700,900,700,900];

  if(seed) frameDelay.shuffle();

  for(var j=0; (demo==="true" ? j<3 : (ntrials<=frameDelay.length ? j<ntrials : j<frameDelay.length)); j++){
    frameSequence.push({ type:"test", message:"", delay: frameDelay[j] });
  }
}

window.onload = function(){
  var scriptName = window.location.pathname.split('/').pop();
  setBodyScale(600,700);

  if ((usage = getUrlParameters("help","",true))){
    showAlert("<p id='helpSpan'><b>"+document.title+"</b><br><i>"+document.querySelector('meta[name=\"copyright\"]').content+
      "</i><br><br><b>Usage:</b><br>"+scriptName+"?urlParam1=1&urlParam2=0<br><br>"+
      "<b>URL Parameters</b>:<br>"+
      "<i>seed=123</i> -- random number generator seed<br>"+
      "<i>ntrials=30</i> -- number of trials (max 60)<br>"+
      "<i>nopractice=true</i> -- omits practice trials<br>"+
      "<i>chooseinput=true</i> -- whether we use chooseinput<br>"+
      "<i>demo=true</i> -- runs in demo mode, only a few test trials<br>"+
      "<i>debug=true</i> -- outputs trial by trial info to the console<br>"+
      "<i>showresults=true</i> -- allows to save results locally in a file<br>"+
      "<i>autosave=true</i> -- will attempt to save results automatically to file<br>"+
      "<i>filename=subject1.csv</i> -- the filename to save results to<br>"+
      "<i>help</i> -- print this message");
    var hs=document.getElementById('helpSpan'); hs.style.textAlign='left'; hs.style.margin='50px';
    return;
  }

  debug = getUrlParameters("debug","",true);
  demo  = getUrlParameters("demo","",true);
  showresults = getUrlParameters("showresults","",true);
  autosave    = getUrlParameters("autosave","",true);
  filename    = getUrlParameters("filename","",true);
  nopractice  = getUrlParameters("nopractice","",true);

  useChooseInput = getUrlParameters("chooseinput","",true);
  if (!useChooseInput || useChooseInput === 'true'){ useChooseInput = true; }
  else if (useChooseInput === 'false'){ useChooseInput = false; }
  else { showAlert("Error: URL parameter 'chooseinput' must be 'true' or 'false'.","","",'20pt'); return; }

  seed = getUrlParameters("seed","",true);
  if (seed){
    if (parseInt(seed)){ seed = parseInt(seed); }
    else if (seed === '0'){ seed = 0; }
    Math.seedrandom(seed);
  }

  ntrials = getUrlParameters("ntrials","",true);
  if (!(ntrials = parseInt(ntrials)) || ntrials > 60 || ntrials < 1) ntrials = 30;

  testVersion = scriptName.replace(/\.[^/.]+$/, "");
  if(!hasTouch) setup('keys');
  else { if (useChooseInput) chooseInput({keyboard:true, touch:true}, setup); else setup('taps'); }
}

function setup(input){
  chosenInput = input;
  tmbUI.UIevents = [input];
  tmbUI.timeout = 2000; // 2s max
  disableSelect(); disableRightClick(); disableDrag(); disableDoubleTapZoom();
  setFrameSequence();
  nextTrial();
}
</script>
</head>
<body>
  <div id="hold" class="stim"><br>WAIT</div>
  <div id="go" class="stim"><br>GO!</div>
  <noscript>
    For full functionality of this site it is necessary to enable JavaScript.<br>
    Here are the <a href="https://www.enable-javascript.com/" target="_blank" rel="noopener noreferrer">instructions</a> how to enable JavaScript in your web browser.
  </noscript>
</body>
</html>

